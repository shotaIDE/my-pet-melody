default_platform(:ios)

platform :ios do
  desc 'Build develop app'
  lane :build_dev do
    generate

    apple_api_issuer_id = ENV['APPLE_API_ISSUER_ID'].to_s
    apple_api_key_id = ENV['APPLE_API_KEY_ID'].to_s

    Dir.chdir('../') do
      sh(
        'flutter build ios --dart-define-from-file dart-defines_dev.json '\
        '--no-codesign '
      )
    end

    sh(
      'xcodebuild archive CODE_SIGNING_ALLOWED=NO '\
      '-workspace ./ios/Runner.xcworkspace '\
      '-scheme Runner '\
      '-configuration Release '\
      '-archivePath ./build/ios/Runner.xcarchive'
    )

    sh(
      'xcodebuild -exportArchive '\
      '-archivePath ./build/ios/Runner.xcarchive '\
      '-exportPath ./build/ios/ipa '\
      '-exportOptionsPlist ./ios/ExportOptions_Develop-AdHoc.plist '\
      '-allowProvisioningUpdates '\
      "-authenticationKeyIssuerID '#{apple_api_issuer_id}' "\
      "-authenticationKeyID '#{apple_api_key_id}' "\
      '-authenticationKeyPath `pwd`/app-store-connect-api-key.p8'
    )

    lane_context[SharedValues::IPA_OUTPUT_PATH] = 'build/ios/ipa/my_pet_melody.ipa'
  end

  desc 'Deploy develop app to Firebase App Distribution'
  lane :deploy_dev do
    build_dev

    firebase_app_distribution(
      app: '1:1051662796035:ios:54af072e93309514651536',
      service_credentials_file: 'fastlane/firebase-app-distribution-develop.json',
      groups: 'testers'
    )
  end
end
